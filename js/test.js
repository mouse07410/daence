/*-
 * Copyright (c) 2020 Taylor R. Campbell
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

const salsa20daence = require('./salsa20daence')
const test = require('tape')

const crypto_dae_salsa20daence =
    salsa20daence.lowlevel.crypto_dae_salsa20daence
const crypto_dae_salsa20daence_open =
    salsa20daence.lowlevel.crypto_dae_salsa20daence_open

test('self-test passes', t => {
    salsa20daence.selftest()
    t.end()
})

function hexdec(s) {
    function hex(i) {
        const c = s.charCodeAt(i)
        if (0x30 <= c && c <= 0x39)
            return c - 0x30
        else if (0x41 <= c && c <= 0x46)
            return c - 0x41 + 0xA
        else if (0x61 <= c && c <= 0x66)
            return c - 0x61 + 0xa
        throw new Error('bad hex digit at ' + i)
    }
    if (s.length % 2)
        throw new Error('invalid hex string')
    u8 = new Uint8Array(s.length/2)
    for (let i = 0; i < s.length/2; i++) {
        hi = hex(2*i)
        lo = hex(2*i + 1)
        u8[i] = (hi << 4) | lo
    }
    return u8
}

const kat = [
    {
        mlen: "0",
        alen: "16",
        m: "",
        m_: "",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "0000000000000000000000000000000000000000000000000000000000000000",
        h: "da2fa7a11e4476ed9dc3384f196c7afd52bc3543af53eca1d498781dc8e91246",
        u: "cb9fdd8b7d715b47fa571f1c27aebda1ed556f4b55a68033f3350fdac10b43f4",
        c: "762709b9b287e7bd12351f2b0371509cc923f6c2ae612e61",
    },
    {
        mlen: "1",
        alen: "16",
        m: "70",
        m_: "70",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "199e0f81c463d5468a299b0c50ef60d219b52698c47aec5d8a40b223500678e9",
        h: "b860cc41353a31d18f44bea79c237bd3921531ed61ea2b280c5fdc236b02cca7",
        u: "ca0397f120d48a492d901f2254ce82ca0892d0c7a61179a4f7db29838d39e92d",
        c: "844c482d0cfb1b658bbdd74ba1404eeeb5206bde14c70ccfec",
    },
    {
        mlen: "2",
        alen: "16",
        m: "7071",
        m_: "7071",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "62b9ad904528391cd1b3c4a75c3f50337bd0dbbe5c3f674ae8caf2d573567e61",
        h: "f8ea8c4aa43831a1ad45a54b68a1aeab81a0a20bf4042b5310174c2262119869",
        u: "f6e114983789324bcfad887a532a53ccc31816434c942a7a3adcea440cf0879c",
        c: "6dce0f262deddde10ba72249e4bddb454119cb8580c6ef763d1e",
    },
    {
        mlen: "3",
        alen: "16",
        m: "707172",
        m_: "707172",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "5113e94f77ac21a5cc0177fa2157cc4f614727a5b5da5ffa0a30b54f60850aa5",
        h: "b690dd3a1edf2489de743ed1e3c6bd93047b87ac06ef22d90ef93731c6ab048d",
        u: "ac4b3e835031edaa2bbe03156726bda452350f9195fcd4580acfbd13674c6268",
        c: "b3e66c3fc5ac774608a2f3d255b6738f0ee28d8b3eda60ac2fed3f",
    },
    {
        mlen: "4",
        alen: "16",
        m: "70717273",
        m_: "70717273",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "f0ff55ab5700a9b17a23ccd49d46eff70139b120cd65fe26f088214a13ac446d",
        h: "bcf61c535749d2709ac96245db02e538df398cc0cc666403418d7eb728b64b98",
        u: "f156f947c26c6498443d838be3c571bab1d9b02c95c80f03d806605f3261e5bb",
        c: "de839ad762740fe5f3284d596109089e45fdc578795299cb824c3cca",
    },
    {
        mlen: "5",
        alen: "16",
        m: "7071727374",
        m_: "7071727374",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "79543c2bd3011f3cabf61331a0eb082686a6b0bd78aebbc850a3b0bd4598a5b2",
        h: "58bb88ebb8615e4689155387a657dbff76d173d0cb60c3deb51fe5604a84e468",
        u: "d0959a8374902d61a27814e8b63aebab36f4cb303caebf5eaf4a7f9ec788586b",
        c: "91850eb531e6162198ead702942debbc59c1616e30ebe629f2348d130b",
    },
    {
        mlen: "6",
        alen: "16",
        m: "707172737475",
        m_: "707172737475",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "bf54490b669d41d4384b0c9f0316d769eab6eaca288a35b8f5370083c002cb4d",
        h: "9873c5599810462e9e2939580058437ec020d073ee6903e0f5a6f268bc75f10e",
        u: "2fc7f16f864fdd0208031a802bb9a2523df3457be9819df4cceb71bda5592a33",
        c: "14b840b3392558f62dfd41747acb52cbc5e812a5d8715eaa9b86a776e3af",
    },
    {
        mlen: "7",
        alen: "16",
        m: "70717273747576",
        m_: "70717273747576",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "4baac0d03f43fd17f3db84bc97802961b82986d1434d416317e0c807bc846dac",
        h: "45b41d51774e9eadca4ff16242742946213bd2d0632e90738bd46aa3f7e79b47",
        u: "3d82843a4d745c237a5414734f348bbccacf8265494e930777b8128dfa5ea3bc",
        c: "81c5243427c8cc5d0ef985b9ab15384f32efc6ea454c7d887b182646883f1e",
    },
    {
        mlen: "8",
        alen: "16",
        m: "7071727374757677",
        m_: "7071727374757677",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "732824bfbd16b6f357b81859da3a9bdb36fd06f81676179ff333740476b6f686",
        h: "8fdf405b620bbaa19a70fd64961e50a24f3ccc2a7ba51c582cafd33c5fe7fbc8",
        u: "d0cacdbffca0825141e8567e017fcccd2a6c0fbce190ccf088dd5aa306d57835",
        c: "8200c3085ba9c392bc384a276f67f8ff988c1dcdb5ab660e02c5d2b9ef498849",
    },
    {
        mlen: "9",
        alen: "16",
        m: "707172737475767778",
        m_: "707172737475767778",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "7b049730234d83bf533e17f09aa27b548a42e386c8154e885f41fab2a6a55e17",
        h: "b366d74801bb445de175ab9d1c695e5d381c6ef5b8fdbd521901625f176aa6a4",
        u: "f2e26553420d4c882507e0e7d7b278592b5582303e597a35e9679bd235e48275",
        c: "7c2772be0bf9e5aa90fbf9041af3948caead0daa0287943cf6688b6180def2ed91",
    },
    {
        mlen: "10",
        alen: "16",
        m: "70717273747576777879",
        m_: "70717273747576777879",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "9b812698a2297286325abe103587085bc81ff06b6552bacc5bdd386b580a83b5",
        h: "2b235e4fec7aa0d7df12a7ae0d497677e98f773c1a403cf789bc9c12e333384f",
        u: "11ec8d3f3c97bfe56496b22b0305757dceab0e05adebb1de72b251d78edfe232",
        c: "1f0151626829065e7b8e79c8da1a56a5be6f02240e96671bf668b3d121e631384206",
    },
    {
        mlen: "11",
        alen: "16",
        m: "707172737475767778797a",
        m_: "707172737475767778797a",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "97aa15dbfeb6c52df34bfad87724110d5166534053fd8105aeec04db42bf1b0f",
        h: "daf8b916e1772628577fbfd2ff15375ae356c0f874094b6feade4936a03074fe",
        u: "19b4e3bf1762d7da9dd2017284d5e89a61bd42b86021588263a572926551ba9c",
        c: "d7e39253df23a93cf06af34ca9b58f3ff92fd591faf4ef1d23fddea6bf3e5ead731c52",
    },
    {
        mlen: "12",
        alen: "16",
        m: "707172737475767778797a7b",
        m_: "707172737475767778797a7b",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "2092473cf50761f85206ff346189b13985f3a229eff33a58b34c27d7e3dbd3db",
        h: "1f75b7be8c1a9a19e21c99318e032ece6ea76339c146b5c572c90512938829c9",
        u: "4dfcb2f5a9f19c4631e398e7c6c3cb63deceb1da65ce631d6065a7b641d3da82",
        c: "ddcc71b2d2b801a973f182bf57706e6b441bff52ba19415e4ee562aaf5ea9ccc75b40388",
    },
    {
        mlen: "13",
        alen: "16",
        m: "707172737475767778797a7b7c",
        m_: "707172737475767778797a7b7c",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "84cd1e77c8b1a6a1941eb34cdd9338dd85e833825e573a1f911e950c10ae2297",
        h: "c5063b361676c732800afc74e417e2f586de76c028d22e129984a697063b4856",
        u: "2fdd46ce74bffd164dbfec9f237433abda5d8b964cf446c481b77d5656f243f4",
        c: "75554db41fb176c7c73623d43057d3dc48a350aa2cb89261c5a567c3f88f343f708df4fda9",
    },
    {
        mlen: "14",
        alen: "16",
        m: "707172737475767778797a7b7c7d",
        m_: "707172737475767778797a7b7c7d",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "569f083e0cf703dc4bd783fa07306486756aeb16c04c652766873388580a2618",
        h: "c9f1d84061c8673aeda2bdcbad3cf7b40b4b0ce911ad78e746aed4dadf74d91c",
        u: "231947fc4f1ddbcab4fd0919c32803916003a680c7204b2ab95d8194e428e1cc",
        c: "f3b9e3e78fc196d85489e653f058e99543219469b6e382a51aaa95bf3d4a7b7eb8ee9d57a561",
    },
    {
        mlen: "15",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e",
        m_: "707172737475767778797a7b7c7d7e",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "957347d6c243bbec7a9cb383af6d20d3965cee9058b7e019776a27f3e165b24c",
        h: "6005e5089f73d7ecbae8a06ab59fd2b01d3c91a6fd802d24a7980c2080de9cb9",
        u: "6d8fb42fe180aaa6edf25ce8fa63d68be70b4fecea549ff1ed67369800d883a8",
        c: "30dad0b473cd10d3080513d104098fcee23961ffa01c574ba76b428a928658905d10d4e8825f4c",
    },
    {
        mlen: "16",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f",
        m_: "707172737475767778797a7b7c7d7e7f",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "5c9c1f8209ea10163fc0862af10e71af537be4149553541b3184187219fd2009",
        h: "52b326c9caa73391488ff7f75c9cdfe99927c3f19c8f4799bef333b22ea79621",
        u: "2218ddf34a39e717202134869b79668906966b85a8809b36200a07a1ddbbfdf2",
        c: "75236be4a3d3df0614d2bd8f2ceb6b12c4e986e918e513fa41a90081283be2ba2273c376dd08c3b2",
    },
    {
        mlen: "17",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f80",
        m_: "707172737475767778797a7b7c7d7e7f80",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "0b70e14933fb764a55520ac2afec3572d1cbf1ef0f8a819f1649c51557164e6b",
        h: "e910f931eb3c59e7d741b55c11d8eb0bead5711f6c4a40a0a36ac9b677a1bf67",
        u: "0b6e71f1f1e5e015cb836a7ec20c17b7838084410021669337af799296e13ca2",
        c: "35ed97cde04e867d6646d7206c9a1afc86751a075cc6bdaebaf7d0d042ca68c6de99aae3bfa0cd67e9",
    },
    {
        mlen: "18",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f8081",
        m_: "707172737475767778797a7b7c7d7e7f8081",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "858c917be6ff2c820e5dc6ff6efdf7b564e8b939db8e4fefe753996b2e2728c7",
        h: "3a19c87bdb3e044189e053805d9b3410c4ce03ec3a40a59f08626b0ad21fd44a",
        u: "41001223ba749e7bd560537f6e1c5d30bc34ccd417097e442e582c003ae82a68",
        c: "ce5361c1f3b8799acf51abc5ae105dea99db455fc4d0c33879e5f83ec7f12d163155717e3ab8da8b1e29",
    },
    {
        mlen: "19",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f808182",
        m_: "707172737475767778797a7b7c7d7e7f808182",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "1116ce4c3ab6555d6c1df9e4d6c734a527900633575d88f26d2cdc78be0975de",
        h: "bda5c578c4b5a386b6ef33b1a121cfe2b5817b7f2bb246cd91470e02d226e5fa",
        u: "4ce0c457c93746ed1ec98b95472c91444ca4220565391b9c9e31c536481fc2e3",
        c: "bd16fdd2ebd7e29e9dfbd07bf73ae8fdaff99fb3809a20319cad7fae72443de660047138211797af03970f",
    },
    {
        mlen: "20",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f80818283",
        m_: "707172737475767778797a7b7c7d7e7f80818283",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "349e6aa92c2c0faa6ca1c03fe5590a0e905ec1af810b5a5fa6e8bbf304d46267",
        h: "0e2a40a2f9aa792125d56602045193883dc5cc1f0e57d6bd39009ec5ee29ef44",
        u: "b0931de0261ab7aa0eea763f8e8d04859cfad53f049b419e0ec802258f30e68d",
        c: "b6eecfc2d50fa56f845e0d757a9c59d8298a59ee2a54148b1476eec2432b2e5b50905d9a11910a068bfcaf98",
    },
    {
        mlen: "21",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f8081828384",
        m_: "707172737475767778797a7b7c7d7e7f8081828384",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "2d7aec58a93fa766ddc66a0e6891c6eec5949d7d2e673a344756aedab7536760",
        h: "34857e128f04c06a7b6ace6ffce9f2996876088828b72814a92bc8ced645763d",
        u: "e71ee727c6eabb06a028d98521e6a4f3611db8e024c654c80607fbb36ea5747b",
        c: "03b637d04e5b0d77c6c140b99716627ce4f04c8d2c49b036ed01e154d16ed3c70e7dd3e25668e260a8bfb3b7aa",
    },
    {
        mlen: "22",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f808182838485",
        m_: "707172737475767778797a7b7c7d7e7f808182838485",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "54eb80d46bdcdb209d5bb5de3d3c27d50a56a0670f44c7461f2b5103a63e209f",
        h: "bba9d7bda795f7b9705990a2f44ab0a496c0bcfc2feea777e066ddf50f59d014",
        u: "822c587bfaa63e39617c15b798ea68a5622c7db4fd640a5ec4028527a0e6808a",
        c: "8993e03339201e7c6fcb17c4e19b4fa8412c617a5bd91bbd265346e345c611ff858141ad1ec442ce9072e38772c4",
    },
    {
        mlen: "23",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f80818283848586",
        m_: "707172737475767778797a7b7c7d7e7f80818283848586",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "2d206921e1b19876791e6e4e3419fa5e60a9ec360738d40464065adb04344391",
        h: "fddb200234601cd95c556ef3d3979d41bf5d6accadc28a33dc3aa4ea35c0a411",
        u: "566529a2b8e279121a0b3d28b95c8fafa58a13f3f31a9eca81a592403df31cb4",
        c: "2cfd1fe271bc8dc6aa8ff86f8cd4d29250fa5720fcd9f9c077d9a8b5062a9a23e27b79e12d22c2eeececccea61351c",
    },
    {
        mlen: "24",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f8081828384858687",
        m_: "707172737475767778797a7b7c7d7e7f8081828384858687",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "89e9ab80e6208153f01c342bc935de5957094e0ea33ddb41537d381812c93fec",
        h: "c9ae25475fb25057f722b9a1394fcc9969dc7116a629904911a41d7c0c73d8bb",
        u: "2194349372c64bb783442227c8dbf29cab22793b31c8c90adb281969ae1ff511",
        c: "99aee961eb465caab356c31ceb087a28ed0d0cca2b732d97a7938e0f1446c2c16ddd3a39e0f2e2dd9a64f0529460ada4",
    },
    {
        mlen: "25",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f808182838485868788",
        m_: "707172737475767778797a7b7c7d7e7f808182838485868788",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "b6fc69d1bcdee94eedb454f4c9ef204510c7b67d05a6ee5bc09de1f9820b0bf0",
        h: "654ccb34c608e4b36d61a7fcf7cc220073ad2191a02a33311c97969a4b1619e7",
        u: "da8296265b3a1cce01522540ff3e7796707ac265ae4940e3e2f0a765140b8bde",
        c: "e55749c4765d25bb1229b7b884a7be1873bfdc92bf28bef0b359b145b2b2e779c33c4ded678ca4c22aeeff33155cad79ad",
    },
    {
        mlen: "26",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f80818283848586878889",
        m_: "707172737475767778797a7b7c7d7e7f80818283848586878889",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "679a30841b2c60b1fbd10d37961400aedf043cef8293237ded3a33d567b082f1",
        h: "d408232105058a6ce09277fb806738c95dd29a3c096e2103d459824384134c44",
        u: "5114f35c9352f760c846ae23759e88262607c58d1f1db681911ed551783f1a79",
        c: "c1ed1e6aa0245740cc4ecb1533d948495d2ae9d0e0a8bc8afc67949cea590a5623ad2f80a8bdcc378c32545c1cf19c0e327e",
    },
    {
        mlen: "27",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f808182838485868788898a",
        m_: "707172737475767778797a7b7c7d7e7f808182838485868788898a",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "565240fec29824e057f34a11fbe348b2a5dbff3bfd1e9c7e1c7b005875985b9e",
        h: "fea6bfb210a797ba08a2fc0be8d23b71293756b6dada813942b45cd57b819dcf",
        u: "5a1bbbe3817dbf943274b687d101e74c4d6ce1e7e031ee5fb12553e35cef03be",
        c: "e134baf6bdf660b2d5657d54de1a36d8f183ac062a292ec255d838206503b7a9fadfc67ff10c855325c1d2bf2b8f42c155a530",
    },
    {
        mlen: "28",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f808182838485868788898a8b",
        m_: "707172737475767778797a7b7c7d7e7f808182838485868788898a8b",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "cd340180f0349f1b3f497f6ef66a1b1ffda4df8511a23582eab7535529d846ab",
        h: "e8a07cf78ccf0a0667dd13c676d7acfb23a5bfa1f5aa2a76e1830e48beb0778a",
        u: "2c277f60b1515a3c638335a12f6ef0af704963d8278ebaee6a3f12220bb679cf",
        c: "1d58a6548207fb20d8307a69335985f0c8e381979f277d00fdf744610626f784a3dd3ab4b1dd6ccd55f23e372f76c3201dc8fd55",
    },
    {
        mlen: "29",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c",
        m_: "707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "0157d349e41530a4f1e8ceb57387c4f40dc2ac6ee17dc12979529ebb56bdb899",
        h: "7a869e2cd476f1b5fe91194f376271528e66c2ccbff3b1b4f516d17e6baae995",
        u: "8ec07f6f0e219056f9d683ebb3d6e535f6719b42730274a110bf5cd4374df038",
        c: "bafc2b4212a6066bc1b2b0d0839a54743219336df76d147d757d3c16173a5475fc0df2a85ab88e0dd870823319a619426566194506",
    },
    {
        mlen: "30",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d",
        m_: "707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "0ff9a30bb77bc429881227ffcd2402c03e548c3fd3d364be2e6c0514d01acf3d",
        h: "8de51dadb41a72e46dd560797c01316b01bf5692e0084d95ad509e4fbabcf8cf",
        u: "cdbc732c78db41e7bdf6037b8d3e160d6df1f628c5c4fd2e9cda4d77996b883d",
        c: "1dbd0743b8dcd590cf438b397c3333d99a2babedb9ed48e6f79b8364d9e4aaaf5d6ef8a0f9f237b03af582d446f240c9e43f032d83e5",
    },
    {
        mlen: "31",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e",
        m_: "707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "fb0bb38a68579c7102b7c70f1192bf1e47869fe1a7ce4029cc2faa4736a75c85",
        h: "64e0185330a119153e3496237ef007895b0415794bcaac79dc4466935aa4d3f3",
        u: "c84559604fbba0f5ee5e977a3fa350aa491ce769fb365b2ad9a4da95ec138aed",
        c: "dd460078fbac7bf63d24a12ca00013c78611b6372b8d54b99e98cb12976c62c528805f13fd3cc3246e06f2777bb0c9bc28b3769f6a829c",
    },
    {
        mlen: "32",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f",
        m_: "707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "56dfc90696f880bbfd257a27dace3ffce290d5750ca7448bfed57b77361bfc42",
        h: "9bd930763a03e95602c96482d30a0da7da2c8e8237547a794c753f0969ab0c7c",
        u: "99e99122d1bd10e40dcc736ae2d57b3bcd150170712d5599007cf041338bcd4e",
        c: "4f79fba5c6821587611154c7a386ca5df87865d5774c73edd9ec09f9412d41ceaf2dfb7638a86b2e0958a3e68a63a4cb0691a9ae350a5eae",
    },
    {
        mlen: "33",
        alen: "16",
        m: "707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f90",
        m_: "707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f90",
        k: "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
        a: "606162636465666768696a6b6c6d6e6f",
        h_a: "59192594ab20e001cbf05f30a779940f7c699bd828bc95796fa724ab421b385d",
        h_m: "0285637b57b6dde5cb69ccc05b7a96968715651951b5256033ffef1311bc1e95",
        h: "9c344e839ead36cd4c258b44448a869cffae9223b6a17314d957eef7460a829d",
        u: "c31b08fdfaecf5c7384a43322da3ceb3fc82bcd41caceada029845b7bd122d8c",
        c: "a5096e6cd6564131dcfbd186cb1e13728e2b6719b0bf719414fb8f328fca052acd4327d1371267961935566318553871b90cc90829a9d960f9",
    },
]

for (let i = 0; i < kat.length; i++) {
    test(`KAT${i} agrees`, t => {
        const k = hexdec(kat[i].k)
        const a = hexdec(kat[i].a)
        const m = hexdec(kat[i].m)
        const c = hexdec(kat[i].c)

        const c0 = salsa20daence(m, a, k)
        t.deepEqual(c0, c)
        const m0 = salsa20daence.open(c, a, k)
        t.deepEqual(m0, m)
        c0[19] ^= 0x02;
        t.equal(salsa20daence.open(c0, a, k), null)

        const abuf = new Uint8Array(a.length + 2)
        const mbuf = new Uint8Array(m.length + 2)
        const cbuf = new Uint8Array(c.length + 2)
        const m0buf = new Uint8Array(m0.length + 2)
        const c0buf = new Uint8Array(c0.length + 2)

        abuf[0] = abuf[a.length + 1] = 0x4e
        mbuf[0] = mbuf[m.length + 1] = 0x55
        cbuf[0] = cbuf[c.length + 1] = 0x3c
        m0buf[0] = m0buf[m.length + 1] = 0xe7
        c0buf[0] = c0buf[c.length + 1] = 0x1f

        abuf.set(a, 1)
        mbuf.set(m, 1)
        cbuf.set(c, 1)
        t.deepEqual(abuf.slice(1, a.length + 1), a)
        t.deepEqual(mbuf.slice(1, m.length + 1), m)
        t.deepEqual(cbuf.slice(1, c.length + 1), c)

        let rv
        rv = crypto_dae_salsa20daence(c0buf,1, mbuf,1,m.length,
          abuf,1,a.length, k)
        t.equal(0, rv)
        t.deepEqual(c0buf.slice(1, c.length + 1), c)

        rv = crypto_dae_salsa20daence_open(m0buf,1, cbuf,1,c.length,
          abuf,1,a.length, k)
        t.equal(0, rv)
        t.deepEqual(m0buf.slice(1, m.length + 1), m)

        c0buf[14] ^= 0x10
        rv = crypto_dae_salsa20daence_open(m0buf, 1, c0buf,1,c.length,
          abuf,1,a.length, k)
        t.equal(rv, -1)

        t.equal(abuf[0], 0x4e)
        t.equal(abuf[a.length + 1], 0x4e)
        t.equal(mbuf[0], 0x55)
        t.equal(mbuf[m.length + 1], 0x55)
        t.equal(cbuf[0], 0x3c)
        t.equal(cbuf[c.length + 1], 0x3c)
        t.equal(m0buf[0], 0xe7)
        t.equal(m0buf[m.length + 1], 0xe7)
        t.equal(c0buf[0], 0x1f)
        t.equal(c0buf[c.length + 1], 0x1f)
    t.end()
    })
}
